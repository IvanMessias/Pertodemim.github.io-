<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perto de Mim - Bancos & ATMs</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        /* [MANTENHA TODO O CSS ANTERIOR] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1e5a70;
            --primary-dark: #164654;
            --primary-light: #2d7a94;
            --secondary: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --background: #FFFFFF;
            --surface: #F8F9FA;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --text-inverse: #FFFFFF;
            --status-available: #4CAF50;
            --status-limited: #FF9800;
            --status-unavailable: #F44336;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }

        body {
            background-color: var(--surface);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-inverse);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo i {
            font-size: 24px;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--text-inverse);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: var(--spacing-md);
        }

        .search-section {
            background: var(--background);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }

        .search-container {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 44px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius-lg);
            font-size: 16px;
            background-color: var(--surface);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(30, 90, 112, 0.2);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .filter-button, .view-toggle {
            background: var(--surface);
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius-lg);
            width: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-button:hover, .view-toggle:hover {
            background: var(--primary-light);
            color: var(--text-inverse);
        }

        .filter-button.active {
            background: var(--primary);
            color: var(--text-inverse);
            border-color: var(--primary);
        }

        .filter-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: var(--text-inverse);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .filter-chip {
            background: var(--surface);
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-chip.active {
            background: var(--primary);
            color: var(--text-inverse);
            border-color: var(--primary);
        }

        .content-panel {
            display: flex;
            flex: 1;
            gap: var(--spacing-lg);
        }

        .locations-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .location-card {
            background: var(--background);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }

        .location-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .location-type {
            display: inline-block;
            background: rgba(30, 90, 112, 0.1);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 600;
        }

        .location-distance {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }

        .location-address {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .status-container {
            margin-bottom: var(--spacing-md);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .status-badge.open {
            background: rgba(76, 175, 80, 0.1);
            color: var(--status-available);
        }

        .status-badge.closed {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.open {
            background: var(--status-available);
        }

        .status-dot.closed {
            background: var(--error);
        }

        .services-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .service-tag {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .service-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .service-dot.available {
            background: var(--status-available);
        }

        .service-dot.unavailable {
            background: var(--text-secondary);
        }

        .card-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-md);
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: var(--text-inverse);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--text-inverse);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-full {
            flex: 1;
            justify-content: center;
        }

        .map-container {
            flex: 1;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            display: none;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .route-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            display: none;
        }

        .route-controls.active {
            display: block;
        }

        .route-info {
            margin-bottom: var(--spacing-md);
        }

        .route-distance, .route-time {
            font-size: 14px;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
        }

        .close-route {
            background: var(--error);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 12px;
        }

        .view-list .locations-list {
            display: flex;
        }

        .view-list .map-container {
            display: none;
        }

        .view-map .locations-list {
            display: none;
        }

        .view-map .map-container {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--background);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .detail-section {
            margin-bottom: var(--spacing-lg);
        }

        .detail-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        .operating-hours {
            width: 100%;
            border-collapse: collapse;
        }

        .operating-hours tr {
            border-bottom: 1px solid #e0e0e0;
        }

        .operating-hours tr:last-child {
            border-bottom: none;
        }

        .operating-hours td {
            padding: var(--spacing-sm) 0;
        }

        .operating-hours .day {
            font-weight: 500;
        }

        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .feature-tag {
            background: var(--surface);
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .location-permission {
            background: var(--warning);
            color: white;
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .location-permission button {
            background: white;
            color: var(--warning);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            margin-top: var(--spacing-sm);
            cursor: pointer;
            font-weight: 600;
        }

        /* Estilos para o painel de roteamento */
        .leaflet-routing-container {
            background: white;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            max-height: 300px;
            overflow-y: auto;
        }

        .leaflet-routing-alt {
            max-height: 200px;
        }

        .loading-route {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            z-index: 1000;
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 768px) {
            .content-panel {
                flex-direction: column;
            }
            
            .view-map .locations-list {
                display: none;
            }
            
            .view-list .map-container {
                display: none;
            }
            
            .map-container {
                height: 500px;
            }

            .route-controls {
                top: 5px;
                right: 5px;
                left: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-map-marker-alt"></i>
                    <h1>Perto de Mim - Bancos & ATMs</h1>
                </div>
                <div class="nav-actions">
                    <button class="nav-button" id="locationButton" title="Atualizar localização">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                    <button class="nav-button" id="menuButton">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="content-panel view-list" id="contentPanel">
                <div class="search-section">
                    <div id="locationPermission" class="location-permission" style="display: none;">
                        <p>Permita o acesso à sua localização para ver bancos mais próximos</p>
                        <button id="enableLocation">Ativar Localização</button>
                    </div>

                    <div class="search-container">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchInput" placeholder="Encontre bancos, ATMs...">
                        </div>
                        <div style="position: relative;">
                            <button class="filter-button" id="filterButton">
                                <i class="fas fa-filter"></i>
                            </button>
                            <div class="filter-badge" id="filterBadge" style="display: none;">0</div>
                        </div>
                        <button class="view-toggle" id="viewToggle">
                            <i class="fas fa-map" id="viewIcon"></i>
                        </button>
                    </div>
                    <div class="quick-filters">
                        <div class="filter-chip active" data-filter="all">Todos</div>
                        <div class="filter-chip" data-filter="agency">Agências</div>
                        <div class="filter-chip" data-filter="atm">ATMs</div>
                        <div class="filter-chip" data-filter="open">Abertos Agora</div>
                    </div>
                </div>

                <div class="locations-list" id="locationsList">
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>Carregando bancos e ATMs...</h3>
                        <p>Obtendo sua localização</p>
                    </div>
                </div>

                <div class="map-container">
                    <div id="map"></div>
                    <div class="route-controls" id="routeControls">
                        <div class="route-info">
                            <div class="route-distance" id="routeDistance">Distância: --</div>
                            <div class="route-time" id="routeTime">Tempo: --</div>
                        </div>
                        <button class="close-route" id="closeRoute">
                            <i class="fas fa-times"></i> Fechar Rota
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <div class="modal" id="detailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">Detalhes do Local</h2>
                    <button class="modal-close" id="modalClose">&times;</button>
                </div>
                <div class="modal-body" id="modalBody"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        // Dados reais de bancos em Maputo
        const REAL_LOCATIONS = [
            {
                id: '1',
                name: 'Banco BCI - Maputo Centro',
                type: 'agency',
                address: 'Av. 25 de Setembro, Maputo',
                coords: {
                    latitude: -25.9692,
                    longitude: 32.5732
                },
                operatingHours: {
                    weekdays: '08:00-15:00',
                    saturdays: '08:00-12:00',
                    sundays: 'Fechado'
                },
                services: {
                    deposits: true,
                    withdrawals: true,
                    customerService: true,
                    transfers: true,
                    investments: true,
                    loans: true
                },
                availability: 'available',
                phone: '+258 84 123 4567',
                features: ['ATM 24h', 'Estacionamento', 'Wi-Fi gratuito', 'Acesso deficientes'],
                isFavorite: false
            },
            {
                id: '2',
                name: 'Standard Bank - Baixa',
                type: 'agency',
                address: 'Av. 25 de Setembro, Maputo',
                coords: {
                    latitude: -25.9675,
                    longitude: 32.5738
                },
                operatingHours: {
                    weekdays: '08:00-15:00',
                    saturdays: '08:00-13:00',
                    sundays: 'Fechado'
                },
                services: {
                    deposits: true,
                    withdrawals: true,
                    customerService: true,
                    transfers: true,
                    investments: true,
                    loans: true
                },
                availability: 'available',
                phone: '+258 84 234 5678',
                features: ['ATM 24h', 'Drive-thru', 'Coleta documentos'],
                isFavorite: false
            },
            {
                id: '3',
                name: 'Millennium BIM - Centro',
                type: 'agency',
                address: 'Praça 16 de Junho, Maputo',
                coords: {
                    latitude: -25.9663,
                    longitude: 32.5791
                },
                operatingHours: {
                    weekdays: '08:00-15:00',
                    saturdays: '08:00-12:00',
                    sundays: 'Fechado'
                },
                services: {
                    deposits: true,
                    withdrawals: true,
                    customerService: true,
                    transfers: true,
                    investments: true,
                    loans: true
                },
                availability: 'available',
                phone: '+258 84 345 6789',
                features: ['ATM interno', 'Estacionamento', 'Sala reuniões'],
                isFavorite: false
            },
            {
                id: '4',
                name: 'ATM BCI 24h - Av. Julius Nyerere',
                type: 'atm',
                address: 'Av. Julius Nyerere, Maputo',
                coords: {
                    latitude: -25.9605,
                    longitude: 32.5774
                },
                operatingHours: {
                    weekdays: '24 horas',
                    saturdays: '24 horas',
                    sundays: '24 horas'
                },
                services: {
                    deposits: false,
                    withdrawals: true,
                    customerService: false,
                    transfers: true,
                    investments: false,
                    loans: false
                },
                availability: 'available',
                features: ['Segurança 24h', 'Acesso deficientes'],
                isFavorite: false
            }
        ];

        // Estado da aplicação
        let state = {
            locations: [],
            filteredLocations: [],
            filters: {
                searchTerm: '',
                type: 'all',
                openNow: false
            },
            viewMode: 'list',
            activeFilters: 0,
            map: null,
            markers: [],
            userLocation: null,
            locationError: false,
            routingControl: null,
            currentRoute: null
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Função para obter localização do usuário
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    console.log('Geolocalização não suportada');
                    state.locationError = true;
                    showLocationPermission();
                    reject(new Error('Geolocalização não suportada'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        state.userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        console.log('Localização obtida:', state.userLocation);
                        hideLocationPermission();
                        resolve(state.userLocation);
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        state.locationError = true;
                        showLocationPermission();
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        }

        function showLocationPermission() {
            const permissionDiv = document.getElementById('locationPermission');
            permissionDiv.style.display = 'block';
        }

        function hideLocationPermission() {
            const permissionDiv = document.getElementById('locationPermission');
            permissionDiv.style.display = 'none';
        }

        // Calcular distância real entre coordenadas
        function calculateRealDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Processar locais com distâncias reais
        function processLocationsWithDistances() {
            return REAL_LOCATIONS.map(location => {
                let distance = 0;
                if (state.userLocation) {
                    distance = calculateRealDistance(
                        state.userLocation.latitude,
                        state.userLocation.longitude,
                        location.coords.latitude,
                        location.coords.longitude
                    );
                }
                
                return {
                    ...location,
                    distance: parseFloat(distance.toFixed(1))
                };
            }).sort((a, b) => a.distance - b.distance);
        }

        async function initializeApp() {
            try {
                await getUserLocation();
            } catch (error) {
                console.log('Usando localização padrão (Maputo centro)');
                state.userLocation = {
                    latitude: -25.9692,
                    longitude: 32.5732
                };
            }

            state.locations = processLocationsWithDistances();
            state.filteredLocations = state.locations;
            
            setupEventListeners();
            initializeMap();
            renderLocationCards();
        }

        function initializeMap() {
            const center = state.userLocation || { latitude: -25.9692, longitude: 32.5732 };
            
            state.map = L.map('map').setView([center.latitude, center.longitude], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(state.map);
            
            // Adicionar marcador da localização do usuário
            if (state.userLocation) {
                const userIcon = L.divIcon({
                    html: '<i class="fas fa-circle" style="color: #1e5a70; font-size: 16px;"></i>',
                    className: 'user-location-marker',
                    iconSize: [16, 16]
                });
                
                L.marker([state.userLocation.latitude, state.userLocation.longitude], { icon: userIcon })
                    .addTo(state.map)
                    .bindPopup('<b>Sua localização atual</b>')
                    .openPopup();
            }
            
            updateMapMarkers();
        }

        // Mostrar loading durante cálculo da rota
        function showRouteLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-route';
            loadingDiv.id = 'routeLoading';
            loadingDiv.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 8px;"></i>
                <div>Calculando rota...</div>
            `;
            document.querySelector('.map-container').appendChild(loadingDiv);
        }

        function hideRouteLoading() {
            const loadingDiv = document.getElementById('routeLoading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Mostrar rota no mapa usando OSRM
        function showRoute(locationId) {
            const location = state.locations.find(loc => loc.id === locationId);
            if (!location || !state.userLocation) return;

            // Limpar rota anterior
            clearRoute();

            // Garantir que estamos no modo mapa
            if (state.viewMode !== 'map') {
                toggleView();
            }

            // Mostrar loading
            showRouteLoading();

            // Configurar o serviço de roteamento OSRM
            state.routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(state.userLocation.latitude, state.userLocation.longitude),
                    L.latLng(location.coords.latitude, location.coords.longitude)
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                }),
                routeWhileDragging: false,
                showAlternatives: false,
                fitSelectedRoutes: true,
                show: false, // Esconder o painel padrão
                collapsible: true,
                language: 'pt',
                createMarker: function(i, waypoint, n) {
                    if (i === 0) {
                        // Marcador de origem (usuário)
                        return L.marker(waypoint.latLng, {
                            icon: L.divIcon({
                                html: '<i class="fas fa-user" style="color: #1e5a70; font-size: 18px;"></i>',
                                className: 'user-route-marker',
                                iconSize: [18, 18]
                            })
                        }).bindPopup('Sua localização');
                    } else {
                        // Marcador de destino (banco/ATM)
                        return L.marker(waypoint.latLng, {
                            icon: L.divIcon({
                                html: '<i class="fas fa-flag" style="color: #4CAF50; font-size: 18px;"></i>',
                                className: 'destination-route-marker',
                                iconSize: [18, 18]
                            })
                        }).bindPopup(location.name);
                    }
                },
                lineOptions: {
                    styles: [{ color: '#1e5a70', weight: 6, opacity: 0.8 }]
                },
                altLineOptions: {
                    styles: [{ color: '#1e5a70', weight: 6, opacity: 0.8 }]
                }
            }).addTo(state.map);

            // Quando a rota é calculada
            state.routingControl.on('routesfound', function(e) {
                hideRouteLoading();
                
                const routes = e.routes;
                const route = routes[0];
                
                if (route) {
                    state.currentRoute = route;
                    
                    // Atualizar informações da rota
                    const distance = (route.summary.totalDistance / 1000).toFixed(1);
                    const time = Math.round(route.summary.totalTime / 60);
                    
                    document.getElementById('routeDistance').textContent = `Distância: ${distance} km`;
                    document.getElementById('routeTime').textContent = `Tempo: ${time} minutos`;
                    
                    // Mostrar controles da rota
                    document.getElementById('routeControls').classList.add('active');
                    
                    // Fechar modal se estiver aberto
                    closeModal();

                    // Ajustar o zoom para mostrar toda a rota
                    state.map.fitBounds(route.coordinates);
                }
            });

            state.routingControl.on('routingerror', function(e) {
                hideRouteLoading();
                console.error('Erro ao calcular rota:', e.error);
                
                // Fallback: mostrar rota simples com linha reta
                showFallbackRoute(location);
            });
        }

        // Fallback para quando o OSRM falha
        function showFallbackRoute(location) {
            // Criar uma linha reta como fallback
            const fallbackRoute = L.polyline([
                [state.userLocation.latitude, state.userLocation.longitude],
                [location.coords.latitude, location.coords.longitude]
            ], {
                color: '#1e5a70',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(state.map);

            // Calcular distância aproximada
            const distance = calculateRealDistance(
                state.userLocation.latitude,
                state.userLocation.longitude,
                location.coords.latitude,
                location.coords.longitude
            ).toFixed(1);

            // Tempo estimado baseado na distância (assumindo 30km/h em área urbana)
            const time = Math.round((distance / 30) * 60);

            document.getElementById('routeDistance').textContent = `Distância: ${distance} km (aproximada)`;
            document.getElementById('routeTime').textContent = `Tempo: ${time} minutos (estimado)`;
            document.getElementById('routeControls').classList.add('active');

            state.currentRoute = {
                summary: {
                    totalDistance: distance * 1000,
                    totalTime: time * 60
                },
                coordinates: [
                    [state.userLocation.latitude, state.userLocation.longitude],
                    [location.coords.latitude, location.coords.longitude]
                ]
            };

            // Ajustar o mapa para mostrar ambos os pontos
            const bounds = L.latLngBounds([
                [state.userLocation.latitude, state.userLocation.longitude],
                [location.coords.latitude, location.coords.longitude]
            ]);
            state.map.fitBounds(bounds.pad(0.1));

            alert('Rota aproximada mostrada. Serviço de roteamento pode estar temporariamente indisponível.');
        }

        // Limpar rota do mapa
        function clearRoute() {
            if (state.routingControl) {
                state.map.removeControl(state.routingControl);
                state.routingControl = null;
            }
            
            // Remover todas as linhas de rota do mapa
            state.map.eachLayer(function(layer) {
                if (layer instanceof L.Polyline) {
                    state.map.removeLayer(layer);
                }
            });
            
            state.currentRoute = null;
            document.getElementById('routeControls').classList.remove('active');
            hideRouteLoading();
        }

        function setupEventListeners() {
            // Botão de localização
            document.getElementById('locationButton').addEventListener('click', async function() {
                try {
                    await getUserLocation();
                    state.locations = processLocationsWithDistances();
                    state.filteredLocations = state.locations;
                    renderLocationCards();
                    
                    if (state.map) {
                        state.map.setView([state.userLocation.latitude, state.userLocation.longitude], 14);
                        updateMapMarkers();
                    }
                } catch (error) {
                    alert('Não foi possível atualizar a localização');
                }
            });

            // Botão para ativar localização
            document.getElementById('enableLocation').addEventListener('click', async function() {
                try {
                    await getUserLocation();
                    state.locations = processLocationsWithDistances();
                    state.filteredLocations = state.locations;
                    renderLocationCards();
                    
                    if (state.map) {
                        state.map.setView([state.userLocation.latitude, state.userLocation.longitude], 14);
                        updateMapMarkers();
                    }
                } catch (error) {
                    alert('Permissão de localização negada. Usando localização padrão.');
                }
            });

            // Fechar rota
            document.getElementById('closeRoute').addEventListener('click', clearRoute);

            // Barra de pesquisa
            document.getElementById('searchInput').addEventListener('input', function(e) {
                state.filters.searchTerm = e.target.value;
                applyFilters();
            });

            // Botão de filtro
            document.getElementById('filterButton').addEventListener('click', function() {
                alert('Funcionalidade de filtros avançados será implementada aqui!');
            });

            // Alternar entre lista e mapa
            document.getElementById('viewToggle').addEventListener('click', toggleView);

            // Filtros rápidos
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    
                    if (filter === 'all') {
                        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                        state.filters.type = 'all';
                        state.filters.openNow = false;
                    } else if (filter === 'agency' || filter === 'atm') {
                        document.querySelector('.filter-chip[data-filter="all"]').classList.remove('active');
                        this.classList.toggle('active');
                        
                        if (this.classList.contains('active')) {
                            state.filters.type = filter;
                        } else {
                            const activeTypeFilters = document.querySelectorAll('.filter-chip[data-filter="agency"].active, .filter-chip[data-filter="atm"].active');
                            if (activeTypeFilters.length === 0) {
                                document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
                                state.filters.type = 'all';
                            }
                        }
                    } else if (filter === 'open') {
                        this.classList.toggle('active');
                        state.filters.openNow = this.classList.contains('active');
                    }
                    
                    applyFilters();
                });
            });

            // Fechar modal
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('detailModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }

        // ... (mantenha as outras funções como antes: toggleView, applyFilters, renderLocationCards, etc.)

        function toggleView() {
            const contentPanel = document.getElementById('contentPanel');
            const viewIcon = document.getElementById('viewIcon');
            
            if (state.viewMode === 'list') {
                state.viewMode = 'map';
                contentPanel.classList.remove('view-list');
                contentPanel.classList.add('view-map');
                viewIcon.className = 'fas fa-list';
                updateMapMarkers();
            } else {
                state.viewMode = 'list';
                contentPanel.classList.remove('view-map');
                contentPanel.classList.add('view-list');
                viewIcon.className = 'fas fa-map';
            }
        }

        function applyFilters() {
            let filtered = [...state.locations];
            
            if (state.filters.searchTerm) {
                const searchLower = state.filters.searchTerm.toLowerCase();
                filtered = filtered.filter(location =>
                    location.name.toLowerCase().includes(searchLower) ||
                    location.address.toLowerCase().includes(searchLower)
                );
            }
            
            if (state.filters.type !== 'all') {
                filtered = filtered.filter(location => location.type === state.filters.type);
            }
            
            if (state.filters.openNow) {
                filtered = filtered.filter(location => isLocationOpen(location.operatingHours));
            }
            
            state.filteredLocations = filtered;
            renderLocationCards();
            
            if (state.viewMode === 'map') {
                updateMapMarkers();
            }
            
            updateFilterBadge();
        }

        function updateFilterBadge() {
            const filterBadge = document.getElementById('filterBadge');
            let count = 0;
            
            if (state.filters.searchTerm) count++;
            if (state.filters.type !== 'all') count++;
            if (state.filters.openNow) count++;
            
            state.activeFilters = count;
            
            if (count > 0) {
                filterBadge.textContent = count;
                filterBadge.style.display = 'flex';
            } else {
                filterBadge.style.display = 'none';
            }
        }

        function isLocationOpen(operatingHours) {
            const now = new Date();
            const currentDay = now.getDay();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            let hoursString;
            
            if (currentDay === 0) {
                hoursString = operatingHours.sundays;
            } else if (currentDay === 6) {
                hoursString = operatingHours.saturdays;
            } else {
                hoursString = operatingHours.weekdays;
            }

            if (hoursString === 'Fechado' || hoursString === '24 horas') {
                return hoursString === '24 horas';
            }

            const [openTime, closeTime] = hoursString.split('-');
            const [openHours, openMinutes] = openTime.split(':').map(Number);
            const [closeHours, closeMinutes] = closeTime.split(':').map(Number);

            const openInMinutes = openHours * 60 + openMinutes;
            const closeInMinutes = closeHours * 60 + closeMinutes;

            return currentTime >= openInMinutes && currentTime <= closeInMinutes;
        }

        function renderLocationCards() {
            const locationsList = document.getElementById('locationsList');
            locationsList.innerHTML = '';
            
            if (state.filteredLocations.length === 0) {
                locationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>Nenhum local encontrado</h3>
                        <p>Tente ajustar seus filtros de busca</p>
                    </div>
                `;
                return;
            }
            
            state.filteredLocations.forEach(location => {
                const card = createLocationCard(location);
                locationsList.appendChild(card);
            });
        }

        function createLocationCard(location) {
            const isOpen = isLocationOpen(location.operatingHours);
            const card = document.createElement('div');
            card.className = 'location-card';
            card.setAttribute('data-id', location.id);
            
            card.innerHTML = `
                <div class="card-header">
                    <div style="flex: 1;">
                        <div class="location-name">${location.name}</div>
                        <div class="location-type">${location.type === 'agency' ? 'Agência Bancária' : 'Caixa Eletrônico'}</div>
                    </div>
                    <div style="text-align: right;">
                        <button class="favorite-btn" style="background: none; border: none; cursor: pointer; font-size: 18px; color: ${location.isFavorite ? 'var(--warning)' : 'var(--text-secondary)'};">
                            <i class="fas fa-star${location.isFavorite ? '' : '-o'}"></i>
                        </button>
                        <div class="location-distance">${location.distance} km</div>
                    </div>
                </div>
                <div class="location-address">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${location.address}</span>
                </div>
                <div class="status-container">
                    <div class="status-badge ${isOpen ? 'open' : 'closed'}">
                        <div class="status-dot ${isOpen ? 'open' : 'closed'}"></div>
                        <span>${isOpen ? 'Aberto agora' : 'Fechado'}</span>
                    </div>
                    <div class="services-list">
                        ${Object.entries(location.services)
                            .map(([service, available]) => `
                                <div class="service-tag">
                                    <div class="service-dot ${available ? 'available' : 'unavailable'}"></div>
                                    <span>${formatServiceName(service)}</span>
                                </div>
                            `).join('')}
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-outline btn-full" onclick="showLocationDetails('${location.id}')">
                        Ver Detalhes
                    </button>
                    <button class="btn btn-primary" onclick="showRouteInApp('${location.id}')">
                        <i class="fas fa-route"></i>
                        Rota
                    </button>
                </div>
            `;
            
            const favoriteBtn = card.querySelector('.favorite-btn');
            favoriteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFavorite(location.id);
            });
            
            return card;
        }

        function formatServiceName(service) {
            const names = {
                deposits: 'Depósitos',
                withdrawals: 'Levantamento',
                customerService: 'Atendimento',
                transfers: 'Transferências',
                loans: 'Empréstimos'
            };
            return names[service] || service;
        }

        function toggleFavorite(locationId) {
            const location = state.locations.find(loc => loc.id === locationId);
            if (location) {
                location.isFavorite = !location.isFavorite;
                renderLocationCards();
                
                if (state.viewMode === 'map') {
                    updateMapMarkers();
                }
            }
        }

        function updateMapMarkers() {
            state.markers.forEach(marker => state.map.removeLayer(marker));
            state.markers = [];
            
            state.filteredLocations.forEach(location => {
                const marker = L.marker([location.coords.latitude, location.coords.longitude])
                    .addTo(state.map)
                    .bindPopup(`
                        <div>
                            <h3>${location.name}</h3>
                            <p>${location.address}</p>
                            <p>Distância: ${location.distance} km</p>
                            <button onclick="showLocationDetails('${location.id}')" style="margin-right: 5px;">Detalhes</button>
                            <button onclick="showRouteInApp('${location.id}')">Rota</button>
                        </div>
                    `);
                
                state.markers.push(marker);
            });
            
            if (state.filteredLocations.length > 0) {
                const group = new L.featureGroup(state.markers);
                state.map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function showLocationDetails(locationId) {
            const location = state.locations.find(loc => loc.id === locationId);
            if (!location) return;
            
            const isOpen = isLocationOpen(location.operatingHours);
            
            document.getElementById('modalTitle').textContent = location.name;
            
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-section">
                    <div class="location-address">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${location.address}</span>
                    </div>
                    <div class="status-badge ${isOpen ? 'open' : 'closed'}" style="margin-top: 8px;">
                        <div class="status-dot ${isOpen ? 'open' : 'closed'}"></div>
                        <span>${isOpen ? 'Aberto agora' : 'Fechado'}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Horário de Funcionamento</h3>
                    <table class="operating-hours">
                        <tr>
                            <td class="day">Segunda a Sexta</td>
                            <td>${location.operatingHours.weekdays}</td>
                        </tr>
                        <tr>
                            <td class="day">Sábado</td>
                            <td>${location.operatingHours.saturdays}</td>
                        </tr>
                        <tr>
                            <td class="day">Domingo</td>
                            <td>${location.operatingHours.sundays}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="detail-section">
                    <h3>Serviços Disponíveis</h3>
                    <div class="services-list">
                        ${Object.entries(location.services)
                            .map(([service, available]) => `
                                <div class="service-tag">
                                    <div class="service-dot ${available ? 'available' : 'unavailable'}"></div>
                                    <span>${formatServiceName(service)}</span>
                                </div>
                            `).join('')}
                    </div>
                </div>
                
                ${location.phone ? `
                <div class="detail-section">
                    <h3>Contato</h3>
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>${location.phone}</span>
                    </div>
                </div>
                ` : ''}
                
                ${location.features && location.features.length > 0 ? `
                <div class="detail-section">
                    <h3>Características</h3>
                    <div class="features-list">
                        ${location.features.map(feature => `
                            <div class="feature-tag">${feature}</div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="modal-actions">
                    <button class="btn btn-outline btn-full" onclick="showRouteInApp('${location.id}'); closeModal();">
                        <i class="fas fa-route"></i>
                        Ver Rota no Mapa
                    </button>
                    ${location.phone ? `
                    <button class="btn btn-primary" onclick="callLocation('${location.phone}')">
                        <i class="fas fa-phone"></i>
                        Ligar
                    </button>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function callLocation(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        // Expor funções para o escopo global
        window.showLocationDetails = showLocationDetails;
        window.showRouteInApp = showRoute;
        window.callLocation = callLocation;
        window.toggleFavorite = toggleFavorite;
        window.clearRoute = clearRoute;
    </script>
</body>
</html>